---
title: "Cox Proportional Hazards Model"
output: html_document
author: "Halley Deleeuw and Jasmine Sawh"
date: '`r Sys.Date()`'
format:
  html:
    code-fold: true
course: STA 6257 - Advanced Statistical Modeling
bibliography: references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---

[Link to Slides](Slides.html) .

## Literature Review 

#### Introduction to Cox Proportional Hazards Model 

The Cox Proportional Hazard model is a powerful tool for survival analysis. This section embarks on a review of myriad articles, illuminating the model's foundations and multifaceted utility. Two seminal articles that lay the groundwork for comprehending the Cox Proportional Hazard model is written by authors Abeysekera and Fan. Abeysekera's insight [@Abeysekera2009] serves as a cornerstone, delving into the model's baseline and validating the assumptions using Schoenfeld's global goodness-of-fit test. In the context of a clinical investigation centered on heroin addicts receiving methadone treatments, this study analyzes three elements. These three components were the influence of the highest methadone dose, the occurrence of a criminal record among participants, and the duration of clinic treatment. The article's distinction in providing a clear and insightful exposition of both the mathematical and coding details were presented at the conclusion of the paper, allowing the reader to grasp the importance of the model. In a complementary stride, Fan's work [@Fan2002] redirects attention to variable selection techniques within the Cox Proportional Hazard model.The article offers a valuable perspective for approaching datasets and identifying pivotal predictors. It address the mathematical rationale behind predictor choice and discusses the variable selection technique. These tools are useful when working on a dataset to choose a predictor and find the outcome of the model when using this approach. 

#### Application of Cox Proportional Hazards Model

The application of the Cox Proportional Hazard model extends to various domains, each shedding light on its adaptability and efficacy. 

In a healthcare context, Ben-Assuli's [@Ben-Assuli2023] study predicts excessive energy consumption in healthcare buildings. The parameters that were studied was building construction, facilities, demographics and climate. The hazard model was deployed on a dataset deriving from 64 healthcare buildings in Spain. The study discerns significant influences, notably demographic and facility-related factors. The unique application of the model to predict every over-consumption underscores its adaptability beyond traditional survival analysis. 

In a different context, Gonzalez-Dominguez utilizes shared frailty with the Cox proportional hazards regression to analyze post discharge survival analysis of CHF patients[@Gonzalez-Dominguez2022]. The goal of the paper is to find the survival probability of patients with congestive heart failure and identify the factors affecting their early mortality within 90 days after hospital discharge. Gonzalez-Dominguez analyzed a total of 18 variables such as patients records with demographic, clinical, medical and lab test data. This study conducted using data from Israeli Sheba Medical Center introduces the concept of shared frailty correction. This is a technique in survival analysis designed to account for unobserved variability among subjects. Unlike the Cox Proportional Hazards model, it assumes that the hazard ratios for different individuals are constant over time and that each observation is independent. The authors dound that shared frailty correction markedly enhances the Cox Proportional Hazard model, particularly in handing dependent obervations.


Equeter takes a unique angle by predicting tool's lifespan in machining [@Equeter2020]. It focuses on predicting the Mean Up Time of cutting tool insets based on a single cutting parameter, cutting speed. They employed the model for the predication and did so by transforming the data. Although this is not a typical use of the model, the authors defended their choice since it was a good fit for assessing tool lifespan and had been using in previous machining studies. The first step in their analysis was generating degradation paths using a gamma process. The gamma process is employed to generate a set of tool lifetimes. In addition, the author used a logarithmic transformation of cutting speed in order to improve in prediction performance. By utilizing a piece wise stochastic model for flank wear, the effects of the tool life was seen from beginning to the end. Employing a gamma process, implementing a logarithmic transformation of cutting speed, and incorporating a piece wise stochastic model for flank wear, the author offers an insightful perspective on the Cox Proportional Hazard model's adaptability to diverse datasets. 

#### Approaches and Presuppositions

Understanding the methods and assumptions behind the Cox Proportional Hazard model is essential for its effective application. Faruk delves into the model's methodology [@Faruk2018]. The researchers used data from the 2012 Indonesian Demographic and Health Survey concentrating specifically on the firs tbirth interval. An examination was conducted that compared the model's efficacy with three accelerated failure time models, Weibull, exponential, and log-normal distributions. The dataset found potential assumptions violations, employing log cumulative hazard plots and various statistical tests. The papers falls short of detailing discussion on the results of the data analysis. Despite this limitation, the analysis identified significant covariates, including women's education level, husband's education level, contraceptive knowledge, access to mass media, wealth index, and employment status.

Deo applies the Cox Proportional Hazard model to study post-surgical patients with stage 3 lung cancer [@Deo2021]. The authors calculated the survival estimates using the Kaplan-Meier estimates.The author navigate the use of log-rank test to compare the survival rates between the two groups (males and females). The paper navigates the advantages and disadvantages of using log-rank test and even goes a step further by discussing the assumptions of the CPH test and how it is advantageous for clinical research. The final analysis observed that patients that are the same age for females have a 41% reduced risk of mortality and a 1 unit increase in age increases the risk of mortality by 1%.

Fox uses Cox Proportional Hazard in a different light. The researchers used the Rossi data set in the carData package in R[@Fox2023]. The data explores recidivism rates among males in a prison. They created a Cox regression time of re-arrest. The detailed analysis of coefficients and survival predicition graphs underscores the model's revlevance in social science research. 

Similarly, Bland goes into depth on what the log-rank test is [@Bland2004]. It is used to compare the survival rates between two groups. The log-rank test gives a comparison at some arbitrary point in the point, instead of comparing the whole survival time to one another. The log-rank test is also based on the same assumptions as the Kaplan test. The log-rank test is also more likely to detect a different in the groups when the risk for the outcome of interest is higher in one of the groups. 

The goal of this study is to see whether hazard ratio, relative risk, and other estimates made by the Cox Proportional Hazards model are biased when the basic assumptions of the model are violated[@Abeysekera2009]. This is significant since regression models are run, not just Cox Proportional Hazards models, many times we take for granted that the assumptions of the model are met. This can lead to incorrect conclusions and predictions. The Cox model assumes that the hazard ratios remain constant over time. If this is violated, then the model may falsely suggest that a variable is significant or vice versa. This study showed an example where the hazards ratio is not constant over time. An example was with the age of smokers and the RR as age increased. As there was an increase in cumulative smoking exposure, the RR decrease after 50. It was also addressed how in the Cox PH model, there is increased emphasis on the Relative Risk. This is convenient because it doesn't require estimating background information. They first examined survival curves by smoking status and then compared a simulated data set could define mortality to a real data set. They found that single minded focus on PH models have hindered the development of other models in epidemiological data. Sometimes hazard functions, rather than the rate of hazard functions may be a better alternative. 

In a related context, Kuitunen and his colleagues highlighted the reporting and adequacy of model details in total joint arthroplasty studies[@Kuitunen2021]. This comprehensive investigation reports the model details as well as the model assumptions with total joint arthroplasty studies. Nearly 80% of the Cox proportional hazards were reported inadequately. However, it is still among the most used models. One of the solutions was to hire statisticians to review the process and make sure reproducible results are created.Another application of the model was when it was testing the strength of proportional hazards [@Ponkilainene2021]. They found a total of 1154 studies by searching for "cox" AND "hazard" in the abstract. The abstract also had to meet the following criteria: the topic must be on knee or hip joint arthroplasty, survival analysis was used, and a hazard ratio was reported. If those criteria were met, the entire article was read. Nearly 80% of the published TJA survival studies reported proportional hazard assumptions of the Cox regression model inadequately. Also, more than one-fifth of the studies were found to include a probable non-proportional Cox model.

The model can also be used to study the relationship between sleepiness and prediction of a driver's impairment[@Vadeby2010]. The approach was to only use the parametric part of the hazard function to study changes in risk of a critical event (lane change) due to changes in the explanatory variables (indicators). The probability of a critical event is proportional to the hazard function and therefore the changes in risk can be estimated by changes in the hazard function. All co-variates were statistically significant.

In this literature review, we have explored the foundation concepts of the Cox Proportional Hazard model, its diverse applications, and the methods and assumptions underlying its use. This collective body of research accentuates the model's profound significant across diverse fields while underscoring the imperative to rigorously evaluate its assumptions and reporting for the attainment of reliable results. 

## Introduction

Cox Proportional Hazard model is a statistical method that has been used for survival analysis and epidemiological research. The model emerged in 1972 by Sir David R. Cox. The model provides researchers with a robust framework for understanding time-to-event data. It uses a semi-parametric estimator that focuses on estimating the hazard function which represents the instantaneous risk of an event occurring at a given time. The purpose of Cox Proportional Hazards regression is to find the relationship between one or more independent variables and the hazard function while allowing for the exploration in non-linearity and time-varying effects[@Abeysekera2009]. 

The fundamental principles of the Cox Proportional Hazard model and its applications range across various research domains. The model primarily focuses on estimating the hazard function, which represents the instantaneous risk of an event occurring at any given time. The dependent variable in a hazard model consist of two parts, the first part is the event indicator and the second part is a measure of time [@Ponkilainene2021]. The model provides invaluable insights across diverse fields such as healthcare, engineering, social sciences, and beyond. It unravels the relationship between covariates and the hazard rate which represents the instantaneous risk of an event occurring at a given time. 

By analyzing how the various predictors influence the hazard rate over time, researchers can gain a deeper understanding of the factors that impact outcomes such as patient survival, equipment failure or the likelihood of an individual re-offering. There are studies using the model to gain more insight on heroin addicts and if they were getting methadone treatments[@Abeysekera2009]. There are even some studies that found the predictive analysis of the energy consumption of healthcare buildings and predict the excessive energy[@Ben-Assuli2023]. The Cox Proportional Hazard model can even be used in predicting the Mean Up Time of cutting tools inserts based on a single cutting parameter, cutting speed[@Equeter2020]. By being able to  study and analyze this, the Cox Proportional Hazard model has become a vital tool for addressing a wide range of research questions. The key strength when it comes to working with Cox Proportional Hazard model is that it is able to handle censor data. Since most studies utilize real-world scenarios such as in a biomedical study conducted [@Ben-Assuli2023] where study the post discharge survival analysis of CHF patients, not all studies completed their observations by the end of the study. For example in the CHF patients, the authors also utilized shared frailty correction technique in order to account for unobserved or variability amount subjects in the study that can effect their likelihood of an event. The Cox Proportional Hazard model also extends its utility to medical research. Another article examines its use in post-discharge survival analysis of congestive heart failure patients, employing not only the Cox Proportional model but also shared frailty correction[@Gonzalez-Dominguez2022].A technique to account for unobserved or variable factors that can influence an individual's risk of an event. This demonstrates the adaptability of the model to address complex medical scenarios. 

Although the diversity with the Cox Proportional Hazard model is myriad, it still has its limitations. Not every data set is fit for the model and can present more issues when using the model to conduct research. In the context of this paper, we delve into a cancer data set sourced from the National Cancer Institute's Surveillance, Epidemiology, and End Results (SEER) Program. Our objective is to scrutinize variables such as site record, sex, age record, cause of death to site record, death classification, and ethnicity, seeking to unveil the factors that influence the time until death. As our analysis unfolds, we aim to shed light on the intricate relationships within the data set and explore the broader implications of our findings.

In the subsequent sections, we will delve deeper into the intricacies of the data set and the methodology employed in our analysis, further illuminating the applications and implications of the Cox Proportional Hazard model in the context of our research.

## Methods

The Cox Proportional Hazard Model is a widely used semiparametric survival analysis method that provides a flexible framework for modeling the hazard rate in the presence of right-censored data. Right-censored data is a type of data where the event of interest like death or failure has not occurred for some of the subjects int he study by the end of observation period. Thus, the exact event time is unknown or not observed for these subjects. In this model, the hazard rate at any time point is expressed as the product of a baseline hazard function, denoted as λ0(t) and an exponential function of a linear combination of covariates. 

Mathematically, the Cox model can be defined as: 

$$
λ(t) = λ0(t) * exp(β₁X₁ + β₂X₂ + ... + βₖXₖ)
$$ 
This is where: 
$λ(t)$ represents the hazard rate at time t.
$λ0(t)$ is the baseline hazard function, representing the hazard in the absence of covariates.
$β₁, β₂, ..., βₖ$ are coefficients associated with covariates $X₁, X₂, ..., Xₖ,$ respectively.

#### Assumptions 

Proportional Hazards Assumption - This assumption of the Cox model states that the effect of covariates on the hazard rate remains constant and is not time-dependent. The hazard ratio between two individuals should stay consistent over time if one individual's covariate values are a constant factor of the other's.

Independence of Censoring - The model assumes that the censoring process (the event of not observing the outcome) is independent of the event of interest. Hence, censoring process is not related to the underlying risk of the event. 

Linearity of Continuous Variables - The model assumes that the log-hazard is a linear function of the covariates for continuous variables. A unit change in the covariate leads to a constant multiplicative change in the hazard rate. 

## Analysis and Results

### Data Description

The data we are using in this study is provided by the National Cancer Institute Surveillance, Epidemiology, and End Results Program also known as SEER. It is a comprehensive cancer surveillance system in the United States. SEER collects and reports data related to cancer incidence, prevalence, survival and mortality. It covers a wide range of demographic, clinical, and tumor-related information for cancer research, prevention, and patience care, making it a valuable resource for understanding cancer trends, outcomes, and risk factors at a national level. This data set will be used as the foundation data set for my Cox Proportional Hazard models. 

```{r, warning=FALSE, echo=T, message=FALSE}
# loading packages 
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggthemes)
library(ggrepel)
library(dslabs)
library(survival)
library(dplyr)
library(survival)
library(gtsummary)
library(gt)
library(htmlTable)
library(IRdisplay)
library(kableExtra)
library(ggplot2)
library(gridExtra)
library(scales)
library(ggplot2)
```

```{r, warning=FALSE, echo=TRUE}
Seer_updated<- read.csv("Seer_updated.csv")
```

Upon reviewing our dataset, it became evident that numerous cancer categories were present. In an effort to enhance our data preprocessing, we generated a bar graph to facilitate the creation of a new column dedicated to this categorical information. As illustrated, the top 10 categories are highlighted, with breast cancer ranking highest, followed by renal cancer. 
```{r, warning=FALSE, echo=TRUE}
Seer_updated %>%
  count(Site.recode.ICD.O.3.WHO.2008) %>%
  arrange(desc(n)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Site.recode.ICD.O.3.WHO.2008, -n), y = n)) +
  geom_bar(stat = "identity", fill = "purple", color = "black") +  
  labs(title = "Top 10 Cancer Typesr",
       x = "Cancer Type",
       y = "Count") +
  theme_minimal() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
In the code below, we begin preprocessing our data based on certain columns and the information we have above. 
```{r, warning=FALSE, echo=TRUE}
#First we select relevant columns and create a new variable, 'survived' to represent survival status based on COD.to.site.recode column.
df <- Seer_updated %>%
  rename(
    Age = Age.recode.with.single.ages.and.85.,
    Race = Race.ethnicity,
    Sex = Sex,
    Origin = Origin.recode.NHIA..Hispanic..Non.Hisp.,
    Year.of.diagnosis = Year.of.diagnosis,
    Survival.months = Survival.months,
    COD_Site =COD.to.site.recode,
    Primary.Site = Primary.Site,
    Median_Household_Income = Median.household.income.inflation.adj.to.2019
  ) %>%
  mutate(survived = ifelse(COD_Site == "Alive", 0, 1))

#We converted certain columns to numeric and adjusted the 'Age' variable so that it is only numeric. 
  df$Age <- sub(" years", "", df$Age)
  df$Age <- as.numeric(df$Age)
  df$Survival.months <- as.numeric(df$Survival.months)
  
#For patient's races, we created broader categoires for better interpretation.
  df$Race_Category <- case_when(
  df$Race %in% c("White") ~ "White",
  df$Race %in% c("Black") ~ "Black",
  df$Race %in% c("Asian Indian", "Asian Indian or Pakistani", "Chinese", "Japanese", "Korean", "Thai", "Vietnamese", "Other Asian") ~ "Asian",
  df$Race %in% c("Chamorran", "Fiji Islander", "Guamanian", "Hawaiian", "Micronesian", "Samoan", "Tahitian", "Tongan", "Pacific Islander") ~ "Pacific      Islander",
  TRUE ~ "Other/Miscellaneous"
)
  
#Based on the bar plot above, we categorizer cancer types into meaningful groups.
df <- df %>%
  mutate(
    Cancer_Group = case_when(
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Breast") ~ "Breast Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Kidney and Renal Pelvis") ~ "Renal Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Thyroid") ~ "Thyroid Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Pancreas") ~ "Pancreatic Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Rectum") ~ "Rectal Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Liver") ~ "Liver Cancer",
      TRUE ~ "Other"
    )
  )

#Created a summary table to better understand our variables
styled_table <- df %>%
  select(
    Age,
    Race_Category,
    Sex,
    survived,
    Origin,
    Year.of.diagnosis,
    Survival.months,  # Modified to use the numeric "Survival.months"
    Cancer_Group,
    Median_Household_Income
  ) %>%
  tbl_summary(
    type = list(
      Age ~ 'continuous2',
      Race_Category ~ 'categorical',
      Sex ~ 'categorical',
      Origin ~ 'categorical',
      Year.of.diagnosis ~ 'continuous2',
      Survival.months ~ 'continuous2',  # Using "Survival.months" as a continuous variable
      Cancer_Group ~ 'categorical',
      Median_Household_Income ~ 'categorical'
    ),
    label = list(
      Age ~ "Patient Age",
      Race_Category ~ "Patient Race",
      Sex ~ "Patient Gender",
      Origin ~ "Patient's Origin",
      Year.of.diagnosis ~ "Year of Diagnosis",
      Survival.months ~ "# of months after diagnosis",
      Cancer_Group ~ "Cause of Death Type",
      Median_Household_Income ~ "Median Household Income"
    ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", "{min}, {max}"),
    by = survived
  ) %>%
 add_overall(last = TRUE) %>%
  bold_labels() %>%
  italicize_levels()
# Export the styled table to an HTML file
html_table <- styled_table %>%
  as_gt() %>%
  gt::as_raw_html()
# Save the HTML table to a file
writeLines(html_table, "styled_table.html", useBytes= TRUE)

styled_table %>%
  as_gt() %>%
  gt::as_raw_html()

```
### Data Visualization

This portion of the paper will provide an understanding of the variables that contribute to survival. The graphs below serve as a preliminary exploration of key demographic elements within our study cohort, encompassing variables such as gender, race, geographic origin, and temporal dynamics indicated by the year of diagnosis.In addition to demographic profiling, we include visual observation of the diversity of cancer types prevalent in the data set. 

Below is the distribution of patient age using a histogram and density plot. We find that majority of the patients are between the ages of 60-70.

```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Age)) +
  geom_histogram(binwidth = 5, fill = "purple", color = "black") +
  labs(title = "Distribution of Patient Age",
       x = "Age",
       y = "Frequency") +
  theme_minimal()


density_plot <- ggplot(df, aes(x = Age)) +
  geom_density(fill = "purple", color = "black") +
  labs(title = "Density Plot of Patient Age",
       x = "Age",
       y = "Density") +
  theme_minimal()

grid.arrange(histogram_plot, density_plot, ncol = 2)
```

Below is a bar chart for race category. The distribution of race categories reveals a significant imbalance, with the number of individuals in the White category being approximately four times greater than in any other race category.

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Race_Category)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of Race Category",
       x = "Race Category",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = comma)

bar_plot
```

Below is the distribution of patient gender. We notice that about 60% of the patients are females and the rest are males. 

```{r, warning=FALSE, echo=TRUE}
pie_chart <- ggplot(df, aes(x = "", fill = Sex)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Distribution of Patient Gender",
       fill = "Gender") +
  theme_minimal() +
  scale_y_continuous(labels = comma)

pie_chart
```

Below is the distribution of the patient origin. It is split into two categories. Non-Spanish-Hispanic-Latino and Spanish-Hispanic-Latino. 

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Origin)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of Patient Origin",
       x = "Origin",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot
```

Below is the distribution of year of diagnosis. The year of diagnosis ranges from 2016 through 2019. It shows that as the years increase, there are more diagnoses made by approximately 5000 every year.

```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Year.of.diagnosis)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "black") +
  labs(title = "Distribution of Year of Diagnosis",
       x = "Year of Diagnosis",
       y = "Count") +
  theme_minimal()

histogram_plot
```

Below is the distribution of survival months. We observe that after diagnosis, there are an ample amount of deaths within the first month. The following months follow a trend towards an exponential decay.


```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Survival.months)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "black") +
  labs(title = "Distribution of Survival Months",
       x = "Survival Months",
       y = "Count") +
  theme_minimal()

histogram_plot
```
Below is the distribution of the type of cancers in the data set. When analyzing the data, we notice that there is a higher count of others compared to breast cancer, colorectal, lung cancer, pancreatic cancer and prostate cancer. 

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Cancer_Group)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot
```
Below is a distribution of those who were diagnosed and are still alive. We can see that many with breast cancer are still alive, as well as kidney and thyroid cancer. 

```{r, warning=FALSE, echo=TRUE}

alive_data <- df[df$survived == 0, ]
alive_data2 <- alive_data %>%
  rename(Cancer_type = Site.recode.ICD.O.3.WHO.2008)
bar_plot2 <- ggplot(alive_data2, aes(x = Cancer_type)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers for Alive Patients",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot2

```
Below is a distribution of those who were diagnosed and are now deceased. Based on the bar graph, pancreatic cancer is the most susceptible to mortality, followed by liver cancer and breast cancer. 

```{r, warning=FALSE, echo=TRUE}

dead_data <- df[df$survived == 1, ]
dead_data2 <- dead_data %>%
  rename(Cancer_type = Site.recode.ICD.O.3.WHO.2008)
bar_plot3 <- ggplot(dead_data2, aes(x = Cancer_type)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers for Deceased Patients",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot3

```

Below is the median household income for patients. Majority of the patients have an income that is above 75,000. 
```{r, warning=FALSE, echo=TRUE}
ggplot(df, aes(x = Median_Household_Income, fill=Median_Household_Income)) +
  geom_bar(color="white") +  
  theme_minimal(base_family="ITC Officina Sans") +
  scale_fill_economist(labels=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1))
```

## Statistical Modeling

In our earlier data preparation steps, we took the time to get our dataset in shape. As part of a thorough quality check, we went on the lookout for any missing values. Interestingly, we noticed that the 'Survival.months' column had some entries labeled as 'Unknown'.To keep things reliable, we decided to drop these entries, ensuring our dataset is all set for the next stages of analysis.

```{r, warning=FALSE, echo=TRUE}
colSums(is.na(df))
df_cleaned <- subset(df, complete.cases(Survival.months))
colSums(is.na(df_cleaned))

```

In the below, we will use Cox Proportional Model to perform survival analysis. Coxph is a function from the survival package in R. Our primary objective is to examine the determinants influencing survival outcomes within a diverse data set of patients. Utilizing the Cox Proportional Hazard model, we explore the impact of key variables such as cancer type, race, gender, age, etc on the likelihood of survival. Our analysis centered on exploring these variables and their associated hazard ratios to better understand their significance in predicting survival. 

We create a model with survival months as our response variable and cancer group, race category, sex, and age as our predictive variable. The table below shows the results of our model. 
```{r, warning=FALSE, echo=TRUE}
cox_model <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age + Cancer_Group, data = df_cleaned)
cox_summary <- summary(cox_model)
table_data <- cox_summary$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```
The model's coefficient estimates and hazard ratios demonstrate the magnitude and direction of the influence of each covariate on survival. The Black race category exhibits a coefficient of 0.0334489, translating to a hazard ratio of 1.0340146 and indicating a 3.4% higher hazard compared to other race categories. Similarly, the Other/Miscellaneous race category, with a coefficient of 0.0608675 and a hazard ratio of 1.0627581, demonstrates a 6.3% increased hazard compared to the reference group. In contrast, Pacific Islander and White race categories do not appear to significantly impact the hazard ratio.Being male has a coefficient of 0.0350546, meaning a hazard ratio of 1.0356763. This implies a 3.6% increase in the hazard of the event for males compared to females.For every one-unit increase in age, there's a hazard ratio of 1.0039630, suggesting a 0.4% increase in the hazard of death per unit increase in age.The impact of cancer types on survival is notable, with Liver Cancer, Other, Pancreatic Cancer, Rectal Cancer, and Renal Cancer groups all showing significant effects (all p-values < 0.05) on the hazard ratios. For example, Liver Cancer, with a coefficient of 0.5915345 and a hazard ratio of 1.8067588, indicates a substantially higher risk of death. Pancreatic Cancer stands out with the highest hazard ratio among these groups, signaling a 2.44 times higher hazard. This observation aligns with our visual representation in the bar graph of cancer types among deceased patients. Conversely, Thyroid Cancer lacks statistical significance, consistent with its lower prevalence among deceased patients according to our bar graph.

Below we check if the proportional hazards assumption holds true for each factor in the Cox model. This assumption is extremely important in survival analysis because it suggests that the influence of factors stays the same over time. The proportional hazards assumption implies that the effect of a variable (like gender, age) on the hazard (or risk) of an event (such as death) remains constant or proportional over different durations or time periods.
```{r, warning=FALSE, echo=TRUE}
cox_residuals <- residuals(cox_model, type = "martingale")
summary(cox_residuals)

cox.zph_result <- cox.zph(cox_model)
print(cox.zph_result)
plot(cox.zph(cox_model))

```
Martingale residuals are a type of residual in survival analysis, specifically designed for Cox Proportional Hazard Models. These residuals are based on the difference between the observed event indicator and the predicted probability of an event at the observed failure time. The martingale residuals are useful for assessing the overall fit of the model and identifying potential patterns or outliers. The Schoenfeld test is a diagnostic test used to assess the proportional hazards assumption in the Cox Proportional Hazard Model. The proportional hazards assumption assumes that the hazard ratio between any two individuals is constant over time. The Schoenfeld test checks if the relationship between the predictor variables and the hazard is constant over time. Based on our results, our proportional hazards assumptions are violated given the p-values. We will use stratifying technique to see if we can improve our model. 

#### Stratified Analysis

Due to our proportional hazards assumptions being violated, we decided to use stratification. Stratification is used to handle the influence of variables that violate the proportional hazards assumption. When certain variables are suspected to have different baseline hazard functions, which means they violate the proportional hazards assumption, we use strata to stratify the model by those variables. This allows each stratum to  have its own baseline hazard function, allowing for varying hazard ratios across strata. For this particular part, we decided to strata sex and age in order to see how our model will perform. 
```{r, warning=FALSE, echo=TRUE}
cox_model_stratified <- coxph(Surv(Survival.months) ~ Race_Category + strata(Sex) + strata(Age) + Cancer_Group, data = df_cleaned)

cox_summary_stratified <- summary(cox_model_stratified)
table_data_stratified <- cox_summary_stratified$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data_stratified, 
      caption = "Stratified Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
The coefficient for being is 0.0350228, leading to a hazard ratio of 1.0356434. This indicates a significant 3.56% increase in the hazard of the event for males compared to females. For every one-unit increase in age, the hazard ratio is 1.0039582, suggesting a significant but minimal 0.40% increase in the hazard of death per unit increase in age. For Thyroid Cancer, the coefficient is -0.0018693, resulting in a hazard ratio of 0.9981324. This is not statistically significant, suggesting that the hazard of the event does not significantly differ for individuals with thyroid cancer compared to the reference group.

```{r, warning=FALSE, echo=TRUE}
cox_stratified_residuals <- residuals(cox_model_stratified, type = "martingale")
summary(cox_stratified_residuals)

cox.zph_result_stratified <- cox.zph(cox_model_stratified)
print(cox.zph_result_stratified)
plot(cox.zph_result_stratified)
```
Given the violation of assumptions observed in our stratified Cox Proportional Hazard Model, particularly in terms of non-proportional hazards for variables like Sex, Age, and Cancer_Group, we decided to refine our analysis by filtering on a specific cancer type, Thyroid Cancer. This strategic filtering allows us to explore the impact of this particular cancer type while potentially mitigating the observed violations.

#### Filtering Analysis with Thyroid Cancer

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Filtered Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
After narrowing down our focus to Thyroid Cancer cases, the Cox Proportional Hazard Model reveals intriguing insights. Black race category has a coefficient of -0.0724061, indicating a hazard ratio of 0.9301531. This suggests a 6.99% decrease in the hazard of Thyroid Cancer compared to other racial categories. Being male has a coefficient of 0.0351059, resulting in a hazard ratio of 1.0357294. This indicates a 3.57% increase in the hazard of the event for males compared to females among thyroid cancer patients. For every one-unit increase in age, there's a hazard ratio of 1.0012238, suggesting a 0.12% increase in the hazard of the event per unit increase in age among thyroid cancer patients.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
By filtering on Thyroid Cancer, we see that our p-values increase a little bit, but our assumptions remain violated. For the Schoenfeld Test the p-value for Race Category is .00042 indicating significant deviation from proportional hazards for Race Category within Thyroid Cancer. For Sex and Age, it has a p-value of .46600 and .09322, respectively. This shows that against a p-value of .05, it is not violating, however our global test emphasizes the challenge in maintaining proportional hazards assumptions within the strata. Based on this, we will use time dependent variables to see if it improves our model. 

#### Time Dependent Analysis

We decided to implement a time dependent covariates as stated above. This approach enables us to examine how the hazard ratios categories change over time, providing a better understanding of their impact on survival outcome. The tt function is used to create time-transformed variables for selected covariates. 
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_time_dep <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age + tt(Race_Category), data = filtered_data)
cox_summary_time_dep <- summary(cox_model_time_dep)
table_data <- cox_summary_time_dep$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Time Dependent Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
The time-dependent Cox proportional hazards model, specifically focusing on "Thyroid Cancer," reveals intriguing findings. Among race categories, while Black race shows a marginal increase 1.57% in the hazard compared to the reference group, Other/Miscellaneous, Pacific Islander, and notably, White race exhibit significantly higher hazard ratios, with White race displaying a remarkably elevated hazard ratio of 14.03. 
Additionally, being male corresponds to a 3.59% higher hazard compared to females among thyroid cancer patients. Age shows a small yet significant impact, with a 0.12% increase in the hazard per unit increase in age. Notably, the time-dependent interaction term (tt(Race_Category)) suggests a varying impact of race categories on the hazard over time, revealing a decrease in hazard ratio for a specified race category with each unit increase in time compared to the reference time point. These findings highlight dynamic variations in hazard ratios concerning race categories and time among patients diagnosed with thyroid cancer.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_time_dep, type = "schoenfeld")
summary(cox_filtered_residuals)

schoen_df <- data.frame(residuals = cox_filtered_residuals, time = filtered_data$Survival.months)

plot(schoen_df$time, schoen_df$Race_Category, type = "p", xlab = "Time", ylab = "Schoenfeld Residuals")
abline(h = 0, col = "purple", lty = 2)  

plot(schoen_df$time, schoen_df$Age, type = "p", xlab = "Time", ylab = "Schoenfeld Residuals")
abline(h = 0, col = "purple", lty = 2) 

plot(schoen_df$time, schoen_df$Sex, type = "p", xlab = "Time", ylab = "Schoenfeld Residuals")
abline(h = 0, col = "purple", lty = 2) 

```
The cox.zph() function does not support time-transformed terms. Nevertheless, we can visually inspect the Schoenfeld residuals through plots to identify trends or patterns that might indicate a violation of the proportional hazards assumption. Our visual examination suggests that the proportional hazards assumption is not met. Consequently, we will explore an alternative approach by incorporating interactions in our model.

#### Interaction Analysis

In survival analysis, an interaction term is often used to assess whether the effect of one variable on the outcome is modified by the presence of another variable. It allows us to explore whether the combined influence of two variables is greater (or different) than the sum of their individual effects.

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category * Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Interaction Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
These results reveal that among thyroid cancer patients, Black race shows a reduced hazard compared to the reference, while being male also slightly decreases the hazard. Additionally, there's a significant interaction effect indicating a higher hazard among Black males specifically, compared to other race-gender combinations.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
The overall or global test for the proportional hazards assumption (GLOBAL) combines all the variables and interactions. With a chi-squared test statistic of 24.625, 10 degrees of freedom, and a p-value of 0.00610, there’s evidence suggesting a violation of the proportional hazards assumption in the model among thyroid cancer cases. These results indicate that while some individual variables or interactions might not violate the assumption significantly(like Sex and Age), the model as a whole shows some evidence of departure from proportional hazards assumption among thyroid cancer patients. To further test this out I decided to use stratification in our next analysis. 

#### Filtered Analysis with Stratification 

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~  Sex + Age + strata(Race_Category), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Stratified Filtered Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
These results highlight the impact of Sex and Age on the hazard ratio among individuals diagnosed with thyroid cancer. Being male is associated with a slightly higher hazard compared to females, and age also shows a small yet significant effect on the hazard ratio in this particular group of patients.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
For Sex, the p-value is 0.396, suggesting no statistically significant violation of the proportional hazards assumption. Regarding Age, the p-value is 0.054, indicating a borderline violation; however, it remains above 0.05. The GLOBAL p-value for the entire model is 0.130. Since this value exceeds 0.05, there is no strong statistical evidence against the assumption of proportional hazards for the model as a whole. Since our p-value went up when disregarding the race-category, we decided to further filter our dataset. 

#### Filtering Analysis on Cancer and Race

Below, we create a new variable called "Binary_Race" where we separate it into a binary variable" Black or other. This helps simplify the analysis and helps us dig deeper. 
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
filtered_data$Binary_Race <- ifelse(filtered_data$Race_Category == "Black", "Black", "Other")
filtered_data$Binary_Race <- as.factor(filtered_data$Binary_Race)
cox_model_filtered <- coxph(Surv(Survival.months) ~ Binary_Race + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Double Filtered Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
In the output above, we run a Cox proportional hazards model focused on individuals with Thyroid Cancer. The variable Binary_RaceOther doesn't show a statistically significant impact, indicating a minimal effect on the hazard ratio between the "Other" racial category and the reference (Black). However, being male exhibits a statistically significant impact, with a coefficient of 0.0324967, suggesting a 3.30% higher hazard compared to females. Moreover, Age displays a statistically significant effect, indicating that for every one-unit increase in age, there's a 0.11% rise in the hazard of the event among individuals diagnosed with thyroid cancer.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
The martingale residuals display a distribution centered around 0, indicating a reasonable fit of the Cox model to the data. The Schoenfeld residuals show that none of the variables significantly violate the proportional hazards assumption individually. The GLOBAL test reinforces this, suggesting that, collectively, the variables do not provide strong evidence against the proportional hazards assumption. By editing the Race_Category we found that our model improved overall. 

#### Filter Analysis with Renal Cancer

Below, we decided to do a similar analysis but focus on Renal Cancer, which was one of our more common cancer types among deceased patients. 
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Filtered Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
None of the race categories show a statistically significant impact on the hazard ratio, as indicated by their respective p-values. This suggests that, within the context of Renal Cancer, these racial categories do not significantly alter the hazard of the event. The coefficient for being male is -0.0041979, resulting in a hazard ratio of 0.9958109. This implies a negligible decrease 0.42% in the hazard of the event for males compared to females with Renal Cancer. However, the effect is not statistically significant, with a p-value of 0.6316300. The coefficient for Age is 0.0042975, corresponding to a hazard ratio of 1.0043067. This indicates a statistically significant 0.43% increase in the hazard of the event for every one-unit increase in age among individuals diagnosed with Renal Cancer.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
Sex shows no evidence of violating the proportional hazards assumption, both Race_Category and especially Age demonstrate substantial departures from the assumption. The global test confirms a significant violation, suggesting that the model doesn't satisfy the assumption of constant hazard ratios over time for renal cancer cases.
 
Given how many of our patients with renal cancer end up passing, it makes sense as to why our variables are statistically significant. We dug deeper and looked into stratifying our model to look at individual variables more closely.

#### Stratification on Renal Cancer Analysis

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + strata(Age), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Stratification on Renal Cancer Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
Across the race categories, none exhibit a statistically significant impact on the hazard ratio, as indicated by their respective p-values. This suggests that, within the context of Renal Cancer and after accounting for age as a stratification variable, these racial categories do not significantly alter the hazard of the event. The coefficient for being male is -0.0020202, resulting in a hazard ratio of 0.9979818. This implies a minimal decrease 0.20% in the hazard of the event for males compared to females with Renal Cancer. Importantly, this effect is not statistically significant, with a p-value of 0.8180026.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
For sex we have a non-significant p-value of .3592, indicating no strong evidence of a departure from proportional hazards for the variable. However, for race_category we have a significant departure from proportional hazards. This indicates that the effect of race on survival time changes over time. Because of this low p-value we decided to use interaction terms as well to see how our model improves. 

#### Interaction Term with Renal Cancer 

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category * Sex + strata(Age), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Interaction for Renal Cancer Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
None of the individual race categories exhibit a statistically significant impact on the hazard ratio, as indicated by their respective p-values. This suggests that, within the context of Renal Cancer and after accounting for age as a stratification variable, the hazard ratios for these race categories do not significantly differ. The coefficient for being male is -0.0726116, resulting in a hazard ratio of 0.9299620. This implies a non-significant decrease 7.00% in the hazard of the event for males compared to females with Renal Cancer, as the p-value is 0.3309375. None of the interaction terms between Race_Category and SexMale are statistically significant. This indicates that the combined effect of race and sex on the hazard ratio does not significantly differ from the sum of their individual effects.

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
Based on our p-values for the Schoenfield Residual test, we are still violating the proportional hazards. Thus, we decided to do a similar approach as last time since Race_Category seems to be the issue. We decided to do the Binary_Race. 

####Binary Race for Renal Cancer Analysis 
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
filtered_data$Binary_Race <- ifelse(filtered_data$Race_Category == "Black", "Black", "Other")
filtered_data$Binary_Race <- as.factor(filtered_data$Binary_Race)
levels(filtered_data$Binary_Race)

cox_model_filtered <- coxph(Surv(Survival.months) ~ Binary_Race * Sex + strata(Age), data = filtered_data)

cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Binary Race for Renal Cancer Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
The coefficient for Binary_RaceOther is 0.0125754, resulting in a hazard ratio of 1.0126548. This implies a non-significant increase 1.27% in the hazard of the event for individuals categorized as "Other" compared to those categorized as "Black" with Renal Cancer, as the p-value is 0.5541234.The coefficient for being male is 0.0164791, resulting in a hazard ratio of 1.0166157. This implies a non-significant increase 1.65% in the hazard of the event for males compared to females with Renal Cancer, as the p-value is 0.5131259. The coefficient for the interaction term is -0.0214101, resulting in a hazard ratio of 0.9788175. This implies a non-significant decrease 2.12% in the hazard of the event for individuals categorized as "Other" compared to those categorized as "Black" specifically among males, as the p-value is 0.4257748.
```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
The Schoenfeld residuals show that none of the variables significantly violate the proportional hazards assumption individually. The GLOBAL test reinforces this, suggesting that, collectively, the variables do not provide strong evidence against the proportional hazards assumption. By editing the Race_Category we found that our model improved overall similar to what was done in our Thyroid Cancer analysis. 

## Conclusion

In this comprehensive analysis, we have successfully identified significant predictors that influence cancer survival, providing insights into the intricate dynamics that contribute to patient outcomes. Our exploration has delved into the multifaceted aspects of survival dynamics, revealing nuances that underscore the complexity of the relationships among various factors and survival duration. The violation of the proportional hazards assumption was identified, prompting a need for further investigation. To address this, we strategically employed advanced methods such as stratification, interaction terms, and the inclusion of time-dependent covariates. We also filtered on different cancer types, such as Thyroid Cancer and Renal Cancer. These approaches were crucial in capturing the evolving nature of predictors over time. Our findings not only illuminate the critical variables impacting cancer survival but also underscore the importance of employing dynamic modeling techniques to unravel the intricacies of survival analysis within this context.By narrowing our focus, we can create a more streamlined and focused model, reducing the influence of confounding variables and enhancing the precision of our analysis.This strategic refinement contributed to a clearer understanding of the specific factors influencing survival outcomes in the context of the selected cancer type. Some of the challenges during this study were that filtering on certain cancer types that had a high mortality, such as pancreatic, led to inflated significance levels, as there's no variability to truly assess the impact of predictors on the vent of intrest within that specific subset. 

Throughout our research encompassing all patients and then focusing on specific cancer types like thyroid and renal cancers, we rigorously assessed the proportional hazards assumption within the Cox models. Despite segmenting the data into these subsets, our attempts to conform to the assumption were met with persistent violations, particularly concerning variables related to race categories and their interactions across different cancer types. This iterative exploration, examining various cancer groups, indicated that these factors consistently displayed deviations from the assumption of constant hazard ratios over time. This persistent violation underscores the complexity of temporal effects in these specific cancer contexts, highlighting the need for nuanced modeling approaches that account for dynamic changes in hazard ratios across diverse patient populations. Despite our efforts to refine analyses by focusing on specific cancer types, the challenge of reconciling varying hazard ratios within the proportional hazards framework persisted, emphasizing the intricacies and potential limitations in modeling survival dynamics across different cancer subgroups.

```
\[ \cite{Abeysekera2009}, \cite{Ben-Assuli2023}, \cite{Equeter2020}, \cite{Fan2002}, \cite{Gonzalez-Dominguez2022}, \cite{Faruk2018}, \cite{Deo2021}, \cite{Fox2023}, \cite{Bland2004}, \cite{Kuitunen2021}, \cite{Ponkilainene2021}, \cite{Vadeby2010} \]
