---
title: "Cox Proportional Hazards Model"
output: html_document
author: "Halley Deleeuw and Jasmine Sawh"
date: '`r Sys.Date()`'
format:
  html:
    code-fold: true
course: STA 6257 - Advanced Statistical Modeling
bibliography: references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---

[Link to Slides](Slides.html)
## Literature Review 

#### Introduction to Cox Proportional Hazards Model 

The Cox Proportional Hazard model is a powerful tool for survival analysis. This section embarks on a review of myriad articles, illuminating the model's foundations and multifaceted utility. Two seminal articles that lay the groundwork for comprehending the Cox Proportional Hazard model is written by authors Abeysekera and Fan. Abeysekera's insight [@Abeysekera2009] serves as a cornerstone, delving into the model's baseline and validating the assumptions using Schoenfeld's global goodness-of-fit test. In the context of a clinical investigation centered on heroin addicts receiving methadone treatments, this study analyzes three elements. These three components were the influence of the highest methadone dose, the occurrence of a criminal record among participants, and the duration of clinic treatment. The article's distinction in providing a clear and insightful exposition of both the mathematical and coding details were presented at the conclusion of the paper, allowing the reader to grasp the importance of the model. In a complementary stride, Fan's work [@Fan2002] redirects attention to variable selection techniques within the Cox Proportional Hazard model.The article offers a valuable perspective for approaching datasets and identifying pivotal predictors. It address the mathematical rationale behind predictor choice and discusses the variable selection technique. These tools are useful when working on a dataset to choose a predictor and find the outcome of the model when using this approach. 

#### Application of Cox Proportional Hazards Model

The application of the Cox Proportional Hazard model extends to various domains, each shedding light on its adaptability and efficacy. 

In a healthcare context, Ben-Assuli's [@Ben-Assuli] study predicts excessive energy consumption in healthcare buildings. The parameters that were studied was building construction, facilities, demographics and climate. The hazard model was deployed on a dataset deriving from 64 healthcare buildings in Spain. The study discerns significant influences, notably demographic and facility-related factors. The unique application of the model to predict every over-consumption underscores its adaptability beyond traditional survival analysis. 

In a different context, Gonzalez-Dominguez utilizes shared frailty with the Cox proportional hazards regression to analyze post discharge survival analysis of CHF patients[@Gonzalez-Dominguez2022]. The goal of the paper is to find the survival probability of patients with congestive heart failure and identify the factors affecting their early mortality within 90 days after hospital discharge. Gonzalez-Dominguez analyzed a total of 18 variables such as patients records with demographic, clinical, medical and lab test data. This study conducted using data from Israeli Sheba Medical Center introduces the concept of shared frailty correction. This is a technique in survival analysis designed to account for unobserved variability among subjects. Unlike the Cox Proportional Hazards model, it assumes that the hazard ratios for different individuals are constant over time and that each observation is independent. The authors dound that shared frailty correction markedly enhances the Cox Proportional Hazard model, particularly in handing dependent obervations.


Equeter takes a unique angle by predicting tool's lifespan in machining [@Equeter2020]. It focuses on predicting the Mean Up Time of cutting tool insets based on a single cutting parameter, cutting speed. They employed the model for the predication and did so by transforming the data. Although this is not a typical use of the model, the authors defended their choice since it was a good fit for assessing tool lifespan and had been using in previous machining studies. The first step in their analysis was generating degradation paths using a gamma process. The gamma process is employed to generate a set of tool lifetimes. In addition, the author used a logarithmic transformation of cutting speed in order to improve in prediction performance. By utilizing a piece wise stochastic model for flank wear, the effects of the tool life was seen from beginning to the end. Employing a gamma process, implementing a logarithmic transformation of cutting speed, and incorporating a piece wise stochastic model for flank wear, the author offers an insightful perspective on the Cox Proportional Hazard model's adaptability to diverse datasets. 

#### Approaches and Presuppositions

Understanding the methods and assumptions behind the Cox Proportional Hazard model is essential for its effective application. Faruk delves into the model's methodology [@Faruk2018]. The researchers used data from the 2012 Indonesian Demographic and Health Survey concentrating specifically on the firs tbirth interval. An examination was conducted that compared the model's efficacy with three accelerated failure time models, Weibull, exponential, and log-normal distributions. The dataset found potential assumptions violations, employing log cumulative hazard plots and various statistical tests. The papers falls short of detailing discussion on the results of the data analysis. Despite this limitation, the analysis identified significant covariates, including women's education level, husband's education level, contraceptive knowledge, access to mass media, wealth index, and employment status.

Deo applies the Cox Proportional Hazard model to study post-surgical patients with stage 3 lung cancer [@Deo2021]. The authors calculated the survival estimates using the Kaplan-Meier estimates.The author navigate the use of log-rank test to compare the survival rates between the two groups (males and females). The paper navigates the advantages and disadvantages of using log-rank test and even goes a step further by discussing the assumptions of the CPH test and how it is advantageous for clinical research. The final analysis observed that patients that are the same age for females have a 41% reduced risk of mortality and a 1 unit increase in age increases the risk of mortality by 1%.

Fox uses Cox Proportional Hazard in a different light. The researchers used the Rossi data set in the carData package in R[@Fox2023]. The data explores recidivism rates among males in a prison. They created a Cox regression time of re-arrest. The detailed analysis of coefficients and survival predicition graphs underscores the model's revlevance in social science research. 

Similarly, Bland goes into depth on what the log-rank test is [@Bland2004]. It is used to compare the survival rates between two groups. The log-rank test gives a comparison at some arbitrary point in the point, instead of comparing the whole survival time to one another. The log-rank test is also based on the same assumptions as the Kaplan test. The log-rank test is also more likely to detect a different in the groups when the risk for the outcome of interest is higher in one of the groups. 

The goal of this study is to see whether hazard ratio, relative risk, and other estimates made by the Cox Proportional Hazards model are biased when the basic assumptions of the model are violated[@Abeysekera2009]. This is significant since regression models are run, not just Cox Proportional Hazards models, many times we take for granted that the assumptions of the model are met. This can lead to incorrect conclusions and predictions. The Cox model assumes that the hazard ratios remain constant over time. If this is violated, then the model may falsely suggest that a variable is significant or vice versa. This study showed an example where the hazards ratio is not constant over time. An example was with the age of smokers and the RR as age increased. As there was an increase in cumulative smoking exposure, the RR decrease after 50. It was also addressed how in the Cox PH model, there is increased emphasis on the Relative Risk. This is convenient because it doesn't require estimating background information. They first examined survival curves by smoking status and then compared a simulated data set could define mortality to a real data set. They found that single minded focus on PH models have hindered the development of other models in epidemiological data. Sometimes hazard functions, rather than the rate of hazard functions may be a better alternative. 

In a related context, Kuitunen and his colleagues highlighted the reporting and adequacy of model details in total joint arthroplasty studies[@Kuitunen2021]. This comprehensive investigation reports the model details as well as the model assumptions with total joint arthroplasty studies. Nearly 80% of the Cox proportional hazards were reported inadequately. However, it is still among the most used models. One of the solutions was to hire statisticians to review the process and make sure reproducible results are created.Another application of the model was when it was testing the strength of proportional hazards [@Ponkilainene2021]. They found a total of 1154 studies by searching for "cox" AND "hazard" in the abstract. The abstract also had to meet the following criteria: the topic must be on knee or hip joint arthroplasty, survival analysis was used, and a hazard ratio was reported. If those criteria were met, the entire article was read. Nearly 80% of the published TJA survival studies reported proportional hazard assumptions of the Cox regression model inadequately. Also, more than one-fifth of the studies were found to include a probable non-proportional Cox model.

The model can also be used to study the relationship between sleepiness and prediction of a driver's impairment[@Vadeby2010]. The approach was to only use the parametric part of the hazard function to study changes in risk of a critical event (lane change) due to changes in the explanatory variables (indicators). The probability of a critical event is proportional to the hazard function and therefore the changes in risk can be estimated by changes in the hazard function. All co-variates were statistically significant.

In this literature review, we have explored the foundation concepts of the Cox Proportional Hazard model, its diverse applications, and the methods and assumptions underlying its use. This collective body of research accentuates the model's profound significant across diverse fields while underscoring the imperative to rigorously evaluate its assumptions and reporting for the attainment of reliable results. 

## Introduction

Cox Proportional Hazard model is a statistical method that has been used for survival analysis and epidemiological research. The model emerged in 1972 by Sir David R. Cox. The model provides researchers with a robust framework for understanding time-to-event data. It uses a semi-parametric estimator that focuses on estimating the hazard function which represents the instantaneous risk of an event occurring at a given time. The purpose of Cox Proportional Hazards regression is to find the relationship between one or more independent variables and the hazard function while allowing for the exploration in non-linearity and time-varying effects[@Abeysekera2009]. 

The fundamental principles of the Cox Proportional Hazard model and its applications range across various research domains. The model primarily focuses on estimating the hazard function, which represents the instantaneous risk of an event occurring at any given time. The dependent variable in a hazard model consist of two parts, the first part is the event indicator and the second part is a measure of time [@Ponkilainene2021]. The model provides invaluable insights across diverse fields such as healthcare, engineering, social sciences, and beyond. It unravels the relationship between covariates and the hazard rate which represents the instantaneous risk of an event occurring at a given time. 

By analyzing how the various predictors influence the hazard rate over time, researchers can gain a deeper understanding of the factors that impact outcomes such as patient survival, equipment failure or the likelihood of an individual re-offering. There are studies using the model to gain more insight on heroin addicts and if they were getting methadone treatments[@Abeysekera2009]. There are even some studies that found the predictive analysis of the energy consumption of healthcare buildings and predict the excessive energy[@Ben-Assuli2023]. The Cox Proportional Hazard model can even be used in predicting the Mean Up Time of cutting tools inserts based on a single cutting parameter, cutting speed[@Equeter2020]. By being able to  study and analyze this, the Cox Proportional Hazard model has become a vital tool for addressing a wide range of research questions. The key strength when it comes to working with Cox Proportional Hazard model is that it is able to handle censor data. Since most studies utilize real-world scenarios such as in a biomedical study conducted [@Ben-Assuli2023] where study the post discharge survival analysis of CHF patients, not all studies completed their observations by the end of the study. For example in the CHF patients, the authors also utilized shared frailty correction technique in order to account for unobserved or variability amount subjects in the study that can effect their likelihood of an event. The Cox Proportional Hazard model also extends its utility to medical research. Another article examines its use in post-discharge survival analysis of congestive heart failure patients, employing not only the Cox Proportional model but also shared frailty correction[@Gonzalez-Dominguez2022].A technique to account for unobserved or variable factors that can influence an individual's risk of an event. This demonstrates the adaptability of the model to address complex medical scenarios. 

Although the diversity with the Cox Proportional Hazard model is myriad, it still has its limitations. Not every data set is fit for the model and can present more issues when using the model to conduct research. In the context of this paper, we delve into a cancer data set sourced from the National Cancer Institute's Surveillance, Epidemiology, and End Results (SEER) Program. Our objective is to scrutinize variables such as site record, sex, age record, cause of death to site record, death classification, and ethnicity, seeking to unveil the factors that influence the time until death. As our analysis unfolds, we aim to shed light on the intricate relationships within the data set and explore the broader implications of our findings.

In the subsequent sections, we will delve deeper into the intricacies of the data set and the methodology employed in our analysis, further illuminating the applications and implications of the Cox Proportional Hazard model in the context of our research.

(SMALL)

## Methods

The Cox Proportional Hazard Model is a widely used semiparametric survival analysis method that provides a flexible framework for modeling the hazard rate in the presence of right-censored data. Right-censored data is a type of data where the event of interest like death or failure has not occurred for some of the subjects int he study by the end of observation period. Thus, the exact event time is unknown or not observed for these subjects. In this model, the hazard rate at any time point is expressed as the product of a baseline hazard function, denoted as λ0(t) and an exponential function of a linear combination of covariates. 

Mathematically, the Cox model can be defined as: 

$$
λ(t) = λ0(t) * exp(β₁X₁ + β₂X₂ + ... + βₖXₖ)
$$ 
This is where: 
$λ(t)$ represents the hazard rate at time t.
$λ0(t)$ is the baseline hazard function, representing the hazard in the absence of covariates.
$β₁, β₂, ..., βₖ$ are coefficients associated with covariates$X₁, X₂, ..., Xₖ,$ respectively.

#### Assumptions 

Proportional Hazards Assumption -  This assumption of the Cox model states that the effect of covariates on the hazard rate remains constant and is not time-dependent. The hazard ratio between two individuals should stay consistent over time if one individual's covariate values are a constant factor of the other's.

Independence of Censoring - The model assumes that the censoring process (the event of not observing the outcome) is independent of the event of interest. Hence, censoring process is not related to the underlying risk of the event. 

Linearity of Continuous Variables - The model assumes that the log-hazard is a linear function of the covariates for continuous variables. A unit change in the covariate leads to a constant multiplicative change in the hazard rate. 

## Analysis and Results

### Data Description

The data we are using in this study is provided by the National Cancer Institute Surveillance, Epidemiology, and End Results Program also known as SEER. It is a comprehensive cancer surveillance system in the United States. SEER collects and reports data related to cancer incidence, prevalence, survival and mortality. It covers a wide range of demographic, clinical, and tumor-related information for cancer research, prevention, and patience care, making it a valuable resource for understanding cancer trends, outcomes, and risk factors at a national level. This data set will be used as the foundation data set for my Cox Proportional Hazard models. 

```{r, warning=FALSE, echo=T, message=FALSE}
# loading packages 
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggthemes)
library(ggrepel)
library(dslabs)
library(survival)
library(dplyr)
library(survival)
library(gtsummary)
library(gt)
library(htmlTable)
library(IRdisplay)
library(kableExtra)
library(ggplot2)
library(gridExtra)
library(scales)
library(ggplot2)
```

```{r, warning=FALSE, echo=TRUE}
Seer_updated<- read.csv("Seer_updated.csv")
```

```{r, warning=FALSE, echo=TRUE}
ggplot(Seer_updated, aes(x = Site.recode.ICD.O.3.WHO.2008)) +
  geom_bar() +
  labs(title = "Bar Graph of site.recorded..", x = "Site Recorded", y = "Count")

Seer_updated %>%
  count(Site.recode.ICD.O.3.WHO.2008) %>%
  arrange(desc(n)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Site.recode.ICD.O.3.WHO.2008, -n), y = n)) +
  geom_bar(stat = "identity") +
  labs(title = "Top 10 Categories of site.recorded..", x = "Site Recorded", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

```{r, warning=FALSE, echo=TRUE}
df <- Seer_updated %>%
  rename(
    Age = Age.recode.with.single.ages.and.85.,
    Race = Race.ethnicity,
    Sex = Sex,
    Origin = Origin.recode.NHIA..Hispanic..Non.Hisp.,
    Year.of.diagnosis = Year.of.diagnosis,
    Survival.months = Survival.months,
    COD_Site =COD.to.site.recode,
    Primary.Site = Primary.Site,
    Median_Household_Income = Median.household.income.inflation.adj.to.2019
  ) %>%
  mutate(survived = ifelse(COD_Site == "Alive", 0, 1))

  df$Age <- sub(" years", "", df$Age)
  df$Age <- as.numeric(df$Age)
  df$Survival.months <- as.numeric(df$Survival.months)
  df$Race_Category <- case_when(
  df$Race %in% c("White") ~ "White",
  df$Race %in% c("Black") ~ "Black",
  df$Race %in% c("Asian Indian", "Asian Indian or Pakistani", "Chinese", "Japanese", "Korean", "Thai", "Vietnamese", "Other Asian") ~ "Asian",
  df$Race %in% c("Chamorran", "Fiji Islander", "Guamanian", "Hawaiian", "Micronesian", "Samoan", "Tahitian", "Tongan", "Pacific Islander") ~ "Pacific      Islander",
  TRUE ~ "Other/Miscellaneous"
)
df <- df %>%
  mutate(
    Cancer_Group = case_when(
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Breast") ~ "Breast Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Kidney and Renal Pelvis") ~ "Renal Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Thyroid") ~ "Thyroid Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Pancreas") ~ "Pancreatic Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Rectum") ~ "Rectal Cancer",
      df$Site.recode.ICD.O.3.WHO.2008 %in% c("Liver") ~ "Liver Cancer",
      TRUE ~ "Other"
    )
  )
styled_table <- df %>%
  select(
    Age,
    Race_Category,
    Sex,
    survived,
    Origin,
    Year.of.diagnosis,
    Survival.months,  # Modified to use the numeric "Survival.months"
    Cancer_Group,
    Median_Household_Income
  ) %>%
  tbl_summary(
    type = list(
      Age ~ 'continuous2',
      Race_Category ~ 'categorical',
      Sex ~ 'categorical',
      Origin ~ 'categorical',
      Year.of.diagnosis ~ 'continuous2',
      Survival.months ~ 'continuous2',  # Using "Survival.months" as a continuous variable
      Cancer_Group ~ 'categorical',
      Median_Household_Income ~ 'categorical'
    ),
    label = list(
      Age ~ "Patient Age",
      Race_Category ~ "Patient Race",
      Sex ~ "Patient Gender",
      Origin ~ "Patient's Origin",
      Year.of.diagnosis ~ "Year of Diagnosis",
      Survival.months ~ "# of months after diagnosis",
      Cancer_Group ~ "Cause of Death Type",
      Median_Household_Income ~ "Median Household Income"
    ),
    statistic = all_continuous() ~ c("{median} ({p25}, {p75})", "{min}, {max}"),
    by = survived
  ) %>%
 add_overall(last = TRUE) %>%
  bold_labels() %>%
  italicize_levels()
# Export the styled table to an HTML file
html_table <- styled_table %>%
  as_gt() %>%
  gt::as_raw_html()
# Save the HTML table to a file
writeLines(html_table, "styled_table.html", useBytes= TRUE)

styled_table %>%
  as_gt() %>%
  gt::as_raw_html()

```
### Data Visualization

This portion of the paper will provide an understanding of the variables that contribute to survival. The graphs below serve as a preliminary exploration of key demographic elements within our study cohort, encompassing variables such as gender, race, geographic origin, and temporal dynamics indicated by the year of diagnosis.In addition to demographic profiling, we include visual observation of the diversity of cancer types prevalent in the data set. 


Below is the distribution of patient age using a histogram and density plot. We find that majority of the patients are between the ages of 60-70.

```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Age)) +
  geom_histogram(binwidth = 5, fill = "purple", color = "black") +
  labs(title = "Distribution of Patient Age",
       x = "Age",
       y = "Frequency") +
  theme_minimal()


density_plot <- ggplot(df, aes(x = Age)) +
  geom_density(fill = "purple", color = "black") +
  labs(title = "Density Plot of Patient Age",
       x = "Age",
       y = "Density") +
  theme_minimal()

grid.arrange(histogram_plot, density_plot, ncol = 2)
```

Below is a bar chart for race category. The distribution of race categories reveals a significant imbalance, with the number of individuals in the White category are approximately four times greater than in any other race category. This highlights the necessity for data preprocessing techniques to ensure robust model performance. 

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Race_Category)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of Race Category",
       x = "Race Category",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = comma)

bar_plot
```

Below is the distribution of patient gender. We notice that about 60% of the patients are females and the rest are males. 

```{r, warning=FALSE, echo=TRUE}
pie_chart <- ggplot(df, aes(x = "", fill = Sex)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Distribution of Patient Gender",
       fill = "Gender") +
  theme_minimal() +
  scale_y_continuous(labels = comma)

pie_chart
```

Below is the distribution of the patient origin. It is split into two categories. Non-Spanish-Hispanic-Latino and Spanish-Hispanic-Latino. 

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Origin)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of Patient Origin",
       x = "Origin",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot
```

Below is the distribution of year of diagnosis. The year of diagnosis ranges from 2016 through 2019. It shows that as the years increase, there are more diagnoses made by approximately 5000 every year.

```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Year.of.diagnosis)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "black") +
  labs(title = "Distribution of Year of Diagnosis",
       x = "Year of Diagnosis",
       y = "Count") +
  theme_minimal()

histogram_plot
```

Below is the distribution of survival months. We observe that after diagnosis, there are an ample amount of deaths within the first month. The following months follow a trend towards an exponential decay.


```{r, warning=FALSE, echo=TRUE}
histogram_plot <- ggplot(df, aes(x = Survival.months)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "black") +
  labs(title = "Distribution of Survival Months",
       x = "Survival Months",
       y = "Count") +
  theme_minimal()

histogram_plot
```
Below is the distribution of the type of cancers in the data set. When analyzing the data, we notice that there is a m=higher count of others compared to breast cancer, colorectal, lung cancer, pancreatic cancer and prostate cancer. 

```{r, warning=FALSE, echo=TRUE}
bar_plot <- ggplot(df, aes(x = Cancer_Group)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot
```
Below is a distribution of those who were diagnosed and are still alive. We can see that many with breast cancer are still alive, as well as kidney and thyroid cancer. 

```{r, warning=FALSE, echo=TRUE}

alive_data <- df[df$survived == 0, ]
alive_data2 <- alive_data %>%
  rename(Cancer_type = Site.recode.ICD.O.3.WHO.2008)
bar_plot2 <- ggplot(alive_data2, aes(x = Cancer_type)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers for Alive Patients",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot2

```
Below is a distribution of those who were diagnosed and are now deceased. Based on the bar graph, pancreatic cancer is the most susceptible to mortality, followed by liver cancer and breast cancer. 

```{r, warning=FALSE, echo=TRUE}

dead_data <- df[df$survived == 1, ]
dead_data2 <- dead_data %>%
  rename(Cancer_type = Site.recode.ICD.O.3.WHO.2008)
bar_plot3 <- ggplot(dead_data2, aes(x = Cancer_type)) +
  geom_bar(fill = "purple") +
  labs(title = "Distribution of the Type of Cancers for Deceased Patients",
       x = "Cancer Group",
       y = "Count") +
  scale_y_continuous(labels = comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

bar_plot3

```

Below is the median household income for patients. Majority of the patients have an income that is above 75,000. 
```{r, warning=FALSE, echo=TRUE}
ggplot(df, aes(x = Median_Household_Income, fill=Median_Household_Income)) +
  geom_bar(color="white") +  
  theme_minimal(base_family="ITC Officina Sans") +
  scale_fill_economist(labels=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1))
```

## Statistical Modeling

```{r, warning=FALSE, echo=TRUE}
colSums(is.na(df))
df_cleaned <- subset(df, complete.cases(Survival.months))
colSums(is.na(df_cleaned))

```

In the below, we will use Cox Proportional Model to perform survival analysis. Coxph is a function from the survival package in R. Our primary objective is to examine the determinants influencing survival outcomes within a diverse data set of patients. Utilizing the Cox Proportional Hazard model, we explore the impact of key variables such as cancer type, race, gender, age, etc on the likelihood of survival. Our analysis centered on exploring these variables and their associated hazard ratios to better understand their significance in predicting survival. 

We create a model with survival as our response variable and cancer group, race category, sex, and age as our predictive variable. The table below shows the results of our model. 
```{r, warning=FALSE, echo=TRUE}
cox_model <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age + Cancer_Group, data = df_cleaned)
cox_summary <- summary(cox_model)
table_data <- cox_summary$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

The model's coefficient estimates and hazard ratios demonstrate the magnitude and direction of the influence of each covariate on survival.
Breast Cancer displays a hazard ratio of approximately 15.32, indicating individuals with breast cancer face around 15.32 times higher risk of death compared to those with "Other" cancer types, holding other variables constant. Similarly, Pancreatic Cancer exhibits a hazard ratio of 14.17, signifying a notably elevated risk of mortality.
Within race categories, Asian and Other/Miscellaneous designations showcase hazard ratios slightly below 1, suggesting marginally lower hazards (or risks) of death compared to the reference group (White). Conversely, Black and Pacific Islander categories demonstrate hazard ratios slightly above 1, implying slightly elevated hazards (or risks) of death compared to the White individuals.
Males exhibit a hazard ratio of approximately 2.33, indicating a 2.33 times higher risk of death compared to females, when other variables are held constant. Each one-unit increase in age corresponds to a 3% increase in the hazard (or risk) of death, holding other factors constant.

Below we check if the proportional hazards assumption holds true for each factor in the Cox model. This assumption is extremely important in survival analysis because it suggests that the influence of factors stays the same over time. The proportional hazards assumption implies that the effect of a variable (like gender, age) on the hazard (or risk) of an event (such as death) remains constant or proportional over different durations or time periods.

For example, if comparing two groups (e.g., males vs. females), the proportional hazards assumption suggests that the ratio of their risks of experiencing the event (like death) remains the same throughout the observation period. This implies that the effect of being male (compared to being female) on the risk of the event doesn't change over time.


```{r, warning=FALSE, echo=TRUE}
cox_residuals <- residuals(cox_model, type = "martingale")
summary(cox_residuals)

cox.zph_result <- cox.zph(cox_model)
print(cox.zph_result)
plot(cox.zph(cox_model))

```
Stratified Analysis

```{r, warning=FALSE, echo=TRUE}
cox_model_stratified <- coxph(Surv(Survival.months) ~ Race_Category + strata(Sex) + strata(Age) + Cancer_Group, data = df_cleaned)

cox_summary_stratified <- summary(cox_model_stratified)
table_data_stratified <- cox_summary_stratified$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data_stratified, 
      caption = "Stratified Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
```{r, warning=FALSE, echo=TRUE}
cox_stratified_residuals <- residuals(cox_model_stratified, type = "martingale")
summary(cox_stratified_residuals)

cox.zph_result_stratified <- cox.zph(cox_model_stratified)
print(cox.zph_result_stratified)
plot(cox.zph_result_stratified)
```
filtering analysis
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
time dependent ... 
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_time_dep <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age + tt(Race_Category), data = filtered_data)
cox_summary_time_dep <- summary(cox_model_time_dep)
table_data <- cox_summary_time_dep$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_time_dep, type = "schoenfeld")
summary(cox_filtered_residuals)

schoen_df <- data.frame(residuals = cox_filtered_residuals, time = filtered_data$Survival.months)

plot(schoen_df$time, schoen_df$Race_Category, type = "p", xlab = "Time", ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red", lty = 2)  # Add a horizontal line at y = 0
```
interaction
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category * Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~  Sex + Age + strata(Race_Category), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Thyroid Cancer")
filtered_data$Binary_Race <- ifelse(filtered_data$Race_Category == "Black", "Black", "Other")
filtered_data$Binary_Race <- as.factor(filtered_data$Binary_Race)
cox_model_filtered <- coxph(Surv(Survival.months) ~ Binary_Race + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```













Renal Cancer

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + Age, data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```
```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category + Sex + strata(Age), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
cox_model_filtered <- coxph(Surv(Survival.months) ~ Race_Category * Sex + strata(Age), data = filtered_data)
cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```
```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```

```{r, warning=FALSE, echo=TRUE}
filtered_data <- filter(df_cleaned, Cancer_Group == "Renal Cancer")
filtered_data$Binary_Race <- ifelse(filtered_data$Race_Category == "Black", "Black", "Other")
filtered_data$Binary_Race <- as.factor(filtered_data$Binary_Race)
levels(filtered_data$Binary_Race)

cox_model_filtered <- coxph(Surv(Survival.months) ~ Binary_Race * Sex + strata(Age), data = filtered_data)

cox_summary_filtered <- summary(cox_model_filtered)
table_data <- cox_summary_filtered$coefficients[, c("coef", "exp(coef)", "Pr(>|z|)")]
kable(table_data, 
      caption = "Cox Proportional Hazard Model Results",
      format = "html", 
      align = "c", 
      col.names = c("Coefficient", "Hazard Ratio", "p-value")) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, warning=FALSE, echo=TRUE}
cox_filtered_residuals <- residuals(cox_model_filtered, type = "martingale")
summary(cox_filtered_residuals)

cox.zph_result_filtered <- cox.zph(cox_model_filtered)
print(cox.zph_result_filtered)
plot(cox.zph_result_filtered)
```




```
\[ \cite{Abeysekera2009}, \cite{Ben-Assuli2023}, \cite{Equeter2020}, \cite{Fan2002}, \cite{Gonzalez-Dominguez2022}, \cite{Faruk2018}, \cite{Deo2021}, \cite{Fox2023}, \cite{Bland2004}, \cite{Kuitunen2021}, \cite{Ponkilainene2021}, \cite{Vadeby2010} \]
